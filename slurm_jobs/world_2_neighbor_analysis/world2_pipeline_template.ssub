#!/bin/bash
#SBATCH --partition=c3_accel
#SBATCH --time=7-00:00:00
#SBATCH --mem=80G
# Note: --gres and --cpus-per-task are now passed by the launcher!

# --- Safety First! ---
trap "echo '๐ SIGTERM received, killing vLLM Server...'; kill \$VLLM_PID 2>/dev/null" SIGTERM

# --- Activate Environment ---
echo "โ Activating Conda environment..."
source /opt/apps/easybuild/software/Anaconda3/2022.05/etc/profile.d/conda.sh
conda activate dt_env
set -e

# --- Clean up old files from previous runs of this specific configuration ---
echo "๐งน Cleaning up old files for this configuration..."
rm -f data/models/hierarchical_encoder_trained.pth 
rm -f "data/visit_sentence/${VEC_METHOD_ENV//\//-}/visits_${NUM_VISITS_ENV}/patients_5000/all_vectors.pkl"
rm -f "data/visit_sentence/${VEC_METHOD_ENV//\//-}/visits_${NUM_VISITS_ENV}/patients_5000/metric_cosine/neighbors_5/neighbors.pkl"


# ==============================================================================
# === โ๏ธ STEP 1: TRAIN THE HIERARCHICAL ENCODER โ๏ธ ===
# ==============================================================================
echo -e "\n--- STEP 1: Running Training for the Hierarchical Encoder ---"
python scripts/world_2_neighbor_analysis/training/train_hierarchical_encoder.py

if [ $? -ne 0 ]; then
    echo "โ ERROR: Training script failed. Halting pipeline."
    exit 1
fi
echo "โ Training complete!"


# ==============================================================================
# === ๐ฅ STEP 2: LAUNCH VLLM & RUN NEIGHBOR ANALYSIS ๐ฅ ===
# ==============================================================================
echo -e "\n--- STEP 2: Igniting vLLM Server and Running Neighbor Analysis ---"
MODEL_PATH="/media/scratch/mferguson/models/unsloth-medgemma-27b-text-it-bnb-4bit"
vllm serve "$MODEL_PATH" --served-model-name medgemma &
VLLM_PID=$!
echo "โ vLLM Server starting with PID: $VLLM_PID"

echo "โณ Waiting for server to be ready..."
while ! curl -s http://localhost:8000/health; do sleep 5; done
echo "โ Server is ready!"

# --- Run Neighbor Computation ---
echo "โ๏ธ Computing nearest neighbors with our new TRAINED encoder..."
python scripts/world_2_neighbor_analysis/compute_nearest_neighbors.py \
    --representation_method "visit_sentence" \
    --vectorizer_method "$VEC_METHOD_ENV" \
    --distance_metric "cosine" \
    --num_visits "$NUM_VISITS_ENV" \
    --num_patients 5000 \
    --num_neighbors 5

# --- Run Neighbor Examination ---
echo "๐ฌ Examining the new neighbors..."
python scripts/world_2_neighbor_analysis/examine_and_correlate_neighbors.py \
    --representation_method "visit_sentence" \
    --vectorizer_method "$VEC_METHOD_ENV" \
    --distance_metric "cosine" \
    --num_visits "$NUM_VISITS_ENV" \
    --num_patients 5000 \
    --num_neighbors 5 \
    --model_name "medgemma"

# ==============================================================================
# === ๐งน STEP 3: CLEANUP ๐งน ===
# ==============================================================================
echo -e "\n--- STEP 3: Shutting down the vLLM server ---"
kill $VLLM_PID
wait $VLLM_PID 2>/dev/null
echo "โ Server shut down."

echo -e "\n๐๐๐ FULL WORLD 2 PIPELINE FINISHED SUCCESSFULLY! ๐๐๐"