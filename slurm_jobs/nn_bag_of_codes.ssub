#!/bin/bash
#SBATCH --job-name=nn_calc_bag_of_codes
#SBATCH --output=logs/nn_calc_bag_of_codes_%j_out.txt
#SBATCH --error=logs/nn_calc_bag_of_codes_%j_err.txt
#SBATCH --partition=c3_short
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=64
#SBATCH --mem=160G
#SBATCH --gres=gpu:1
#SBATCH --time=3:00:00

# --- RITUAL PARAMETERS ---
NUM_PATIENTS=5000
NUM_VISITS=6
REPRESENTATION="bag_of_codes"
VECTORIZER="biobert-mnli-mednli"
DISTANCE_METRIC="euclidean"
NUM_NEIGHBORS=10
NUM_WORKERS=60

echo "--- Nearest Neighbor Ritual Parameters ---"
echo "Representation: $REPRESENTATION"
echo "Patients: $NUM_PATIENTS"
echo "Visits: $NUM_VISITS"
echo "Vectorizer: $VECTORIZER"
echo "Distance Metric: $DISTANCE_METRIC"
echo "Neighbors: $NUM_NEIGHBORS"
echo "Workers: $NUM_WORKERS"
echo "------------------------------------------"

# --- Environment Setup ---
module load Python/3.11.5-GCCcore-13.2.0
source /opt/apps/easybuild/software/Anaconda3/2022.05/etc/profile.d/conda.sh
conda activate vllm_env

# --- Navigate to project directory ---
cd /mnt/dell_storage/homefolders/librad.laureateinstitute.org/mferguson/Digital-Twins/

# --- Run Nearest Neighbor Computation ---
echo "$(date): Running nearest neighbor computation..."
$CONDA_PREFIX/bin/python scripts/calculations/compute_nearest_neighbors.py \
  --representation_method $REPRESENTATION \
  --num_patients $NUM_PATIENTS \
  --num_visits $NUM_VISITS \
  --vectorizer_method $VECTORIZER \
  --distance_metric $DISTANCE_METRIC \
  --num_neighbors $NUM_NEIGHBORS
echo "$(date): Neighbor computation complete."

echo "$(date): Nearest neighbor ritual complete ðŸ§ âœ¨"

conda deactivate
