#!/bin/bash
#SBATCH --job-name=generate_all_term_pairs_DEBUG
#SBATCH --partition=c3_accel
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --time=7-00:00:00
#SBATCH --output=slurm_jobs/world_4_embedder_gauntlet/logs/gen_pairs.out
#SBATCH --error=slurm_jobs/world_4_embedder_gauntlet/logs/gen_pairs.err

echo "üöÄ Powering up the Synonym Invention Machine with DIAGNOSTIC SCANNERS! üöÄ"

# --- Bulletproof Environment Activation ---
# This is a more direct way to make SURE we get the right Conda environment!
echo "Activating Conda environment..."
source /opt/apps/easybuild/software/Anaconda3/2022.05/etc/profile.d/conda.sh
conda activate hugging_env

# --- Diagnostic Scanner ---
echo "--- PRE-FLIGHT CHECK ---"
echo "üêç Which Python are we using?"
which python
echo "üì¶ What packages are installed?"
pip list
echo "------------------------"
echo ""

# --- Step 1: Launch the vLLM Brain in the Background! ---
echo "üß† Firing up the vLLM server with MedGemma..."
MODEL_PATH="/media/scratch/mferguson/models/unsloth-medgemma-27b-text-it-bnb-4bit"
vllm serve $MODEL_PATH \
  --model-name medgemma \
  --dtype float16 \
  --gpu-memory-utilization 0.9 \
  --max-model-len 4096 &
VLLM_PID=$!
echo "‚úÖ vLLM server started with PID: $VLLM_PID"

# --- Step 2: Give the Brain a Moment to Warm Up! ---
echo "‚è≥ Giving the server 60 seconds to initialize..."
sleep 60

# --- Step 3: Run Our Magnificent Python Script! ---
echo "ü§ñ Unleashing the Synonym Invention Machine!"
python scripts/world_4_embedder_gauntlet/generate_term_pairs.py
echo "‚úÖ Synonym Invention Machine has finished its work!"

# --- Step 4: Clean Up Our Beautiful Experiment! ---
echo "üßπ Shutting down the vLLM server (PID: $VLLM_PID). Great work, little brain!"
kill $VLLM_PID
wait $VLLM_PID

echo "üéâ AHAHAHA! IT'S ALL DONE! The entire ecosystem has been built and dismantled! Perfect execution!"